#!/bin/bash

# MarioKartWorldParams 專案 - Commit Message Hook
# 檢查 commit message 是否符合規範

set -e

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# 顏色定義
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# 檢查 commit message 是否為空
if [ -z "$COMMIT_MSG" ]; then
    echo ""
    echo -e "${RED}❌ 錯誤：commit message 不能為空${NC}"
    echo ""
    exit 1
fi

# 檢查是否為 merge commit（跳過檢查）
if [[ "$COMMIT_MSG" =~ ^Merge ]]; then
    exit 0
fi

# 檢查是否符合格式：<type>: <description>
if [[ ! "$COMMIT_MSG" =~ ^(feat|fix|refactor|docs|style|test|chore|hotfix):.+ ]]; then
    echo ""
    echo -e "${RED}❌ Commit message 格式錯誤${NC}"
    echo ""
    echo "目前的 commit message："
    echo "  $COMMIT_MSG"
    echo ""
    echo "📋 正確格式："
    echo "  <type>: <描述>"
    echo ""
    echo "📝 可用的類型："
    echo "  • feat     - 新功能"
    echo "  • fix      - Bug 修復"
    echo "  • refactor - 程式碼重構"
    echo "  • docs     - 文件更新"
    echo "  • style    - 樣式調整"
    echo "  • test     - 測試相關"
    echo "  • chore    - 雜項任務"
    echo "  • hotfix   - 緊急修復"
    echo ""
    echo "✅ 正確範例："
    echo "  feat: 新增語言選擇器元件"
    echo "  fix: 修正登入按鈕點擊無反應的問題"
    echo "  refactor: 重構 Jotai 狀態管理結構"
    echo "  docs: 更新 README 安裝說明"
    echo ""
    echo "💡 提示："
    echo "  • 描述請使用繁體中文"
    echo "  • 冒號後面要有空格"
    echo "  • 描述要簡潔明確"
    echo ""
    exit 1
fi

# 檢查冒號後是否有空格
if [[ ! "$COMMIT_MSG" =~ ^[a-z]+:\ .+ ]]; then
    echo ""
    echo -e "${YELLOW}⚠️  警告：冒號後面應該要有空格${NC}"
    echo ""
    echo "目前：$COMMIT_MSG"
    echo "建議：${COMMIT_MSG/: /:\ }"
    echo ""
    # 這是警告，不阻止提交
fi

# 檢查描述是否太短（少於 5 個字元）
TYPE=$(echo "$COMMIT_MSG" | cut -d':' -f1)
DESC=$(echo "$COMMIT_MSG" | cut -d':' -f2- | xargs)

if [ ${#DESC} -lt 5 ]; then
    echo ""
    echo -e "${YELLOW}⚠️  警告：commit message 描述過短${NC}"
    echo ""
    echo "目前描述：$DESC (${#DESC} 個字元)"
    echo "建議至少 5 個字元以上，讓描述更清楚"
    echo ""
    # 這是警告，不阻止提交
fi

# 通過檢查
echo -e "${GREEN}✅ Commit message 格式正確${NC}"
exit 0
